<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XMLResultBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Decima Framework XML Support</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.decima.xml.assessment.result</a> &gt; <span class="el_source">XMLResultBuilder.java</span></div><h1>XMLResultBuilder.java</h1><pre class="source lang-java linenums">/**
 * Portions of this software was developed by employees of the National Institute
 * of Standards and Technology (NIST), an agency of the Federal Government and is
 * being made available as a public service. Pursuant to title 17 United States
 * Code Section 105, works of NIST employees are not subject to copyright
 * protection in the United States. This software may be subject to foreign
 * copyright. Permission in the United States and in foreign countries, to the
 * extent that NIST may hold copyright, to use, copy, modify, create derivative
 * works, and distribute this software and its documentation without fee is hereby
 * granted on a non-exclusive basis, provided that this notice and disclaimer
 * of warranty appears in all copies.
 *
 * THE SOFTWARE IS PROVIDED 'AS IS' WITHOUT ANY WARRANTY OF ANY KIND, EITHER
 * EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, ANY WARRANTY
 * THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY IMPLIED WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND FREEDOM FROM
 * INFRINGEMENT, AND ANY WARRANTY THAT THE DOCUMENTATION WILL CONFORM TO THE
 * SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE ERROR FREE.  IN NO EVENT
 * SHALL NIST BE LIABLE FOR ANY DAMAGES, INCLUDING, BUT NOT LIMITED TO, DIRECT,
 * INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES, ARISING OUT OF, RESULTING FROM,
 * OR IN ANY WAY CONNECTED WITH THIS SOFTWARE, WHETHER OR NOT BASED UPON WARRANTY,
 * CONTRACT, TORT, OR OTHERWISE, WHETHER OR NOT INJURY WAS SUSTAINED BY PERSONS OR
 * PROPERTY OR OTHERWISE, AND WHETHER OR NOT LOSS WAS SUSTAINED FROM, OR AROSE OUT
 * OF THE RESULTS OF, OR USE OF, THE SOFTWARE OR SERVICES PROVIDED HEREUNDER.
 */

package gov.nist.secauto.decima.xml.assessment.result;

import gov.nist.secauto.decima.core.assessment.result.AssessmentResults;
import gov.nist.secauto.decima.core.assessment.result.BaseRequirementResult;
import gov.nist.secauto.decima.core.assessment.result.DerivedRequirementResult;
import gov.nist.secauto.decima.core.assessment.result.TestResult;
import gov.nist.secauto.decima.core.assessment.result.TestStatus;
import gov.nist.secauto.decima.core.document.Context;
import gov.nist.secauto.decima.core.document.SourceInfo;
import gov.nist.secauto.decima.core.requirement.BaseRequirement;
import gov.nist.secauto.decima.core.requirement.DerivedRequirement;
import gov.nist.secauto.decima.core.requirement.RequirementsManager;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.jdom2.Document;
import org.jdom2.Element;
import org.jdom2.Namespace;
import org.jdom2.output.Format;
import org.jdom2.output.XMLOutputter;

import java.io.IOException;
import java.io.OutputStream;
import java.net.URI;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

// TODO: Improve the target document handling for error context
public class XMLResultBuilder {
<span class="nc" id="L60">  private static final Logger log = LogManager.getLogger(XMLResultBuilder.class);</span>
<span class="nc" id="L61">  private static final Namespace RESULT_NAMESPACE</span>
<span class="nc" id="L62">      = Namespace.getNamespace(&quot;http://csrc.nist.gov/ns/decima/results/1.0&quot;);</span>

<span class="nc" id="L64">  public XMLResultBuilder() {</span>
<span class="nc" id="L65">  }</span>

  /**
   * Writes a provided set of {@link AssessmentResults} to the provided {@link OutputStream} as an XML
   * document.
   * 
   * @param results
   *          the results of an assessment to use
   * @param out
   *          the {@link OutputStream} to write the XML results to
   * @throws IOException
   *           if an error occurs while writing to the provided {@link OutputStream}
   */
  public void write(AssessmentResults results, OutputStream out) throws IOException {
<span class="nc" id="L79">    Document doc = newDocument(results);</span>
<span class="nc" id="L80">    XMLOutputter xout = new XMLOutputter(Format.getPrettyFormat());</span>
<span class="nc" id="L81">    xout.output(doc, out);</span>
<span class="nc" id="L82">  }</span>

  protected Map&lt;String, String&gt; buildSubjects(Element root, AssessmentResults results) {
<span class="nc" id="L85">    Map&lt;String, String&gt; systemIdToSubjectIdMap = new HashMap&lt;&gt;();</span>

<span class="nc" id="L87">    Element element = new Element(&quot;subjects&quot;, root.getNamespace());</span>
<span class="nc" id="L88">    root.addContent(element);</span>

<span class="nc" id="L90">    int nextSubjectId = 1;</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">    for (SourceInfo info : results.getAssessmentSubjects().values()) {</span>
<span class="nc" id="L92">      Element subject = new Element(&quot;subject&quot;, root.getNamespace());</span>
<span class="nc" id="L93">      String id = &quot;sub&quot; + nextSubjectId++;</span>
<span class="nc" id="L94">      systemIdToSubjectIdMap.put(info.getSystemId(), id);</span>
<span class="nc" id="L95">      subject.setAttribute(&quot;id&quot;, id);</span>
<span class="nc" id="L96">      subject.addContent(new Element(&quot;href&quot;, root.getNamespace()).addContent(info.getSystemId()));</span>

<span class="nc" id="L98">      URI source = info.getSource();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">      if (source != null) {</span>
<span class="nc" id="L100">        subject.addContent(new Element(&quot;source&quot;, root.getNamespace()).addContent(source.toString()));</span>
      }
<span class="nc" id="L102">      element.addContent(subject);</span>
<span class="nc" id="L103">    }</span>
    //
    // // iterate over the subjects
    // for (BaseRequirementResult base : results.getBaseRequirementResults()) {
    // for (DerivedRequirementResult derived : base.getDerivedRequirementResults()) {
    // for (TestResult test : derived.getTestResults()) {
    // Context context = test.getContext();
    // if (context != null) {
    // String systemId = context.getSystemId();
    // if (systemId != null) {
    // // map the systemId
    // }
    // }
    // }
    // }
    // }
<span class="nc" id="L119">    return Collections.unmodifiableMap(systemIdToSubjectIdMap);</span>
  }

  protected void buildProperties(Element root, Map&lt;String, String&gt; properties) {
<span class="nc" id="L123">    Element element = new Element(&quot;properties&quot;, root.getNamespace());</span>
<span class="nc" id="L124">    root.addContent(element);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">    for (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) {</span>
<span class="nc" id="L126">      Element property = new Element(&quot;property&quot;, root.getNamespace());</span>
<span class="nc" id="L127">      property.setAttribute(&quot;name&quot;, entry.getKey());</span>
<span class="nc" id="L128">      property.setText(entry.getValue());</span>
<span class="nc" id="L129">      element.addContent(property);</span>
<span class="nc" id="L130">    }</span>
<span class="nc" id="L131">  }</span>

  protected void buildRequirements(Element root, AssessmentResults results) {
<span class="nc" id="L134">    Element element = new Element(&quot;requirements&quot;, root.getNamespace());</span>
<span class="nc" id="L135">    root.addContent(element);</span>

<span class="nc" id="L137">    RequirementsManager manager = results.getRequirementsManager();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">    for (URI definition : manager.getRequirementDefinitions()) {</span>
<span class="nc" id="L139">      Element requirement = new Element(&quot;requirement&quot;, root.getNamespace());</span>
<span class="nc" id="L140">      requirement.setAttribute(&quot;href&quot;, definition.toASCIIString());</span>
<span class="nc" id="L141">      element.addContent(requirement);</span>
<span class="nc" id="L142">    }</span>
<span class="nc" id="L143">  }</span>

  protected void buildResults(Element root, AssessmentResults results, Map&lt;String, String&gt; systemIdToSubjectIdMap) {
<span class="nc" id="L146">    Namespace namespace = root.getNamespace();</span>
<span class="nc" id="L147">    Element element = new Element(&quot;results&quot;, namespace);</span>
<span class="nc" id="L148">    root.addContent(element);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">    for (BaseRequirementResult base : results.getBaseRequirementResults()) {</span>
<span class="nc" id="L150">      element.addContent(buildBaseRequirement(base, namespace, systemIdToSubjectIdMap));</span>
<span class="nc" id="L151">    }</span>
<span class="nc" id="L152">  }</span>

  private static Element buildBaseRequirement(BaseRequirementResult result, Namespace namespace,
      Map&lt;String, String&gt; systemIdToSubjectIdMap) {
<span class="nc" id="L156">    Element retval = new Element(&quot;base-requirement&quot;, namespace);</span>

<span class="nc" id="L158">    BaseRequirement base = result.getBaseRequirement();</span>
<span class="nc" id="L159">    retval.setAttribute(&quot;id&quot;, base.getId());</span>

<span class="nc" id="L161">    Element status = new Element(&quot;status&quot;, namespace).setText(result.getStatus().name());</span>
<span class="nc" id="L162">    retval.addContent(status);</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">    for (DerivedRequirementResult derived : result.getDerivedRequirementResults()) {</span>
<span class="nc" id="L165">      retval.addContent(buildDerivedRequirement(derived, namespace, systemIdToSubjectIdMap));</span>
<span class="nc" id="L166">    }</span>
<span class="nc" id="L167">    return retval;</span>
  }

  private static Element buildDerivedRequirement(DerivedRequirementResult result, Namespace namespace,
      Map&lt;String, String&gt; systemIdToSubjectIdMap) {
<span class="nc" id="L172">    Element retval = new Element(&quot;derived-requirement&quot;, namespace);</span>

<span class="nc" id="L174">    DerivedRequirement derived = result.getDerivedRequirement();</span>
<span class="nc" id="L175">    retval.setAttribute(&quot;id&quot;, derived.getId());</span>

<span class="nc" id="L177">    Element status = new Element(&quot;status&quot;, namespace).setText(result.getStatus().name());</span>
<span class="nc" id="L178">    retval.addContent(status);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">    for (TestResult test : result.getTestResults()) {</span>
<span class="nc" id="L180">      retval.addContent(buildTestResult(test, derived, namespace, systemIdToSubjectIdMap));</span>
<span class="nc" id="L181">    }</span>

<span class="nc" id="L183">    return retval;</span>
  }

  private static Element buildTestResult(TestResult result, DerivedRequirement derived, Namespace namespace,
      Map&lt;String, String&gt; systemIdToSubjectIdMap) {
<span class="nc" id="L188">    Element retval = new Element(&quot;test&quot;, namespace);</span>

<span class="nc" id="L190">    String testId = result.getTestId();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">    if (testId != null) {</span>
<span class="nc" id="L192">      retval.setAttribute(&quot;test-id-ref&quot;, testId);</span>
    }

<span class="nc" id="L195">    TestStatus status = result.getStatus();</span>
<span class="nc" id="L196">    retval.addContent(new Element(&quot;status&quot;, namespace).setText(status.name()));</span>

<span class="nc" id="L198">    List&lt;String&gt; values = result.getResultValues();</span>
<span class="nc" id="L199">    String message = derived.getMessageText(values.toArray(new String[values.size()]));</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (message != null) {</span>
<span class="nc" id="L201">      retval.addContent(new Element(&quot;message&quot;, namespace).setText(message));</span>
    }

<span class="nc" id="L204">    Context context = result.getContext();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">    if (context != null) {</span>
<span class="nc" id="L206">      Element location = new Element(&quot;location&quot;, namespace).setAttribute(&quot;line&quot;, Integer.toString(context.getLine()))</span>
<span class="nc" id="L207">          .setAttribute(&quot;column&quot;, Integer.toString(context.getColumn()));</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">      if (context.getSystemId() != null) {</span>
<span class="nc" id="L210">        String id = systemIdToSubjectIdMap.get(context.getSystemId());</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (id != null) {</span>
<span class="nc" id="L212">          location.setAttribute(&quot;subject-ref&quot;, id);</span>
        } else {
<span class="nc" id="L214">          log.error(&quot;Unable to find subject id for location systemId: {}&quot;, context.getSystemId());</span>
        }
      }

      // TODO: Find a better way to handle this. Maybe a property map?
<span class="nc bnc" id="L219" title="All 2 branches missed.">      if (context instanceof XPathContext) {</span>
<span class="nc" id="L220">        String xpath = ((XPathContext) context).getXPath();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (xpath != null) {</span>
<span class="nc" id="L222">          location.setAttribute(&quot;xpath&quot;, ((XPathContext) context).getXPath());</span>
        }
      }
<span class="nc" id="L225">      retval.addContent(location);</span>
    }

<span class="nc" id="L228">    return retval;</span>
  }

  private static String dateToString(ZonedDateTime dateTime) {
<span class="nc" id="L232">    return dateTime.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME);</span>
  }

  /**
   * Creates a new JDOM {@link Document} based on the provided {@link AssessmentResults}.
   * 
   * @param results
   *          the results of an assessment to use
   * @return a JDOM {@link Document} containing an XML representation of the results
   */
  public Document newDocument(AssessmentResults results) {
<span class="nc" id="L243">    Element root = new Element(&quot;assessment-results&quot;, RESULT_NAMESPACE);</span>

<span class="nc" id="L245">    root.setAttribute(&quot;start&quot;, dateToString(results.getStartTimestamp()));</span>
<span class="nc" id="L246">    root.setAttribute(&quot;end&quot;, dateToString(results.getEndTimestamp()));</span>

<span class="nc" id="L248">    Map&lt;String, String&gt; systemIdToSubjectIdMap = buildSubjects(root, results);</span>
<span class="nc" id="L249">    Map&lt;String, String&gt; properties = results.getProperties();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">    if (!properties.isEmpty()) {</span>
<span class="nc" id="L251">      buildProperties(root, properties);</span>
    }
<span class="nc" id="L253">    buildRequirements(root, results);</span>
<span class="nc" id="L254">    buildResults(root, results, systemIdToSubjectIdMap);</span>
<span class="nc" id="L255">    Document doc = new Document(root);</span>
<span class="nc" id="L256">    return doc;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>